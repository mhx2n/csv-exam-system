<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Exam</title>
<style>
body{font-family:Arial;padding:20px}
.correct{background:#ddffdd}
.wrong{background:#ffdddd}
</style>

<script type="module">

import { db } from './firebase.js';
import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

let examData;
let userAnswers={};
let timeLeft;
let timerInterval;

async function loadExam(){

    const querySnapshot=await getDocs(collection(db,"exams"));
    querySnapshot.forEach((doc)=>{
        examData=doc.data();
    });

    if(!examData){
        document.body.innerHTML="<h2>No Exam Available</h2>";
        return;
    }

    document.getElementById("title").innerText=examData.name;
    renderQuestions();
    startTimer();
}

function renderQuestions(){

    let html="";

    examData.questions.forEach((q,i)=>{
        html+=`<div id="q${i}">
        <p><b>${i+1}. ${q.questions}</b></p>`;

        for(let j=1;j<=5;j++){
            if(q["option"+j]){
                html+=`<label>
                <input type="radio" name="q${i}" value="${j}">
                ${q["option"+j]}
                </label><br>`;
            }
        }

        html+="</div><hr>";
    });

    document.getElementById("examArea").innerHTML=html;
}

function startTimer(){

    timeLeft=examData.timer*60;

    timerInterval=setInterval(()=>{
        timeLeft--;
        document.getElementById("timer").innerText=
        "Time Left: "+Math.floor(timeLeft/60)+":"+timeLeft%60;

        if(timeLeft<=0){
            submitExam();
        }
    },1000);
}

window.submitExam=function(){

    clearInterval(timerInterval);

    let score=0;

    examData.questions.forEach((q,i)=>{
        let selected=document.querySelector(`input[name="q${i}"]:checked`);
        if(selected){

            if(parseInt(selected.value)==parseInt(q.answer)){
                score++;
                document.getElementById("q"+i).classList.add("correct");
            }else{
                score-=examData.negative;
                document.getElementById("q"+i).classList.add("wrong");
            }
        }

        document.getElementById("q"+i).innerHTML+=
        `<p>Correct: ${q.answer}</p>
         <p>Explanation: ${q.explanation}</p>`;
    });

    document.getElementById("result").innerText="Final Score: "+score;
}

window.onload=loadExam;

</script>
</head>
<body>

<h2 id="title"></h2>
<h3 id="timer"></h3>

<div id="examArea"></div>
<button onclick="submitExam()">Submit</button>

<h3 id="result"></h3>

</body>
</html>
    timerInterval=setInterval(()=>{
        timeLeft--;
        document.title="Time Left: "+Math.floor(timeLeft/60)+":"+timeLeft%60;
        if(timeLeft<=0){
            clearInterval(timerInterval);
            submitExam();
        }
    },1000);
}

function submitExam(){
    clearInterval(timerInterval);
    let score=0;

    filteredQuestions.forEach((q,i)=>{
        let selected=document.querySelector(`input[name="q${i}"]:checked`);
        if(selected){
            userAnswers[i]=selected.value;
            if(parseInt(selected.value)==parseInt(q.answer)){
                score++;
                document.getElementById("q"+i).classList.add("correct");
            }else{
                document.getElementById("q"+i).classList.add("wrong");
            }
        }
        document.getElementById("q"+i).innerHTML+=
        `<p><i>Correct: ${q.answer}</i></p>
         <p><i>Explanation: ${q.explanation}</i></p>`;
    });

    document.getElementById("result").innerText=
        "Score: "+score+" / "+filteredQuestions.length;

    document.getElementById("exportBtn").classList.remove("hidden");
}

function exportResult(){
    let csv="Question,Your Answer,Correct\n";
    filteredQuestions.forEach((q,i)=>{
        csv+=`"${q.questions}",${userAnswers[i]||""},${q.answer}\n`;
    });

    let blob=new Blob([csv],{type:"text/csv"});
    let link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download="result.csv";
    link.click();
}

</script>

</body>
</html>
